<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI/ML Solar Power Prediction Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'solar-blue': '#0ea5e9',
                        'solar-green': '#10b981',
                        'solar-dark': '#1e293b'
                    },
                    backdropBlur: {
                        'xs': '2px',
                    }
                }
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://helloteger.app.n8n.cloud/webhook/c5ef8374-73d7-4175-a512-ace9121e0c38/chat"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />
    <script type="module">
        import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';

        createChat({
            webhookUrl: 'https://hackovate.app.n8n.cloud/webhook/1ee38206-f5a0-440c-a196-33af56bfaa37/chat',
            initialMessages: [
            "üëã Welcome to Solify! How can i help you?"
            ]
        });
    </script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900 min-h-screen overflow-hidden">
    <!-- Animated Background -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute -top-40 -right-40 w-80 h-80 bg-gradient-to-br from-blue-400/20 to-cyan-400/20 rounded-full blur-3xl animate-pulse"></div>
        <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-gradient-to-br from-green-400/20 to-emerald-400/20 rounded-full blur-3xl animate-pulse delay-1000"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-96 h-96 bg-gradient-to-br from-purple-400/10 to-pink-400/10 rounded-full blur-3xl animate-pulse delay-500"></div>
    </div>

    <!-- Header -->
    <header class="relative z-50 bg-white/10 backdrop-blur-md border-b border-white/20 shadow-lg">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <!-- Logo -->
                <div class="flex items-center space-x-3">
                    <div class="p-2 bg-gradient-to-br from-solar-blue to-solar-green rounded-xl shadow-lg">
                        <i class="fas fa-solar-panel text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold bg-gradient-to-r from-white to-blue-100 bg-clip-text text-transparent">Solify</h1>
                        <p class="text-xs text-blue-200">AI Solar Predictions</p>
                    </div>
                </div>

                <!-- Right Side -->
                <div class="flex items-center space-x-3">
                    <!-- Google Translate -->
                    <div id="google_translate_element" class="relative"></div>

                    <!-- Download Buttons -->
                    <div id="downloadBtns" class="hidden flex space-x-2">
                        <button id="downloadCsvBtn" class="px-3 py-2 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg hover:from-green-600 hover:to-emerald-600 transition-all duration-200 shadow-lg hover:shadow-xl text-sm font-medium">
                            <i class="fas fa-file-csv mr-1"></i>CSV
                        </button>
                        <button id="downloadPdfBtn" class="px-3 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-lg hover:from-blue-600 hover:to-cyan-600 transition-all duration-200 shadow-lg hover:shadow-xl text-sm font-medium">
                            <i class="fas fa-file-pdf mr-1"></i>PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Custom CSS for Google Translate -->
    <style>
        .goog-logo-link, .goog-te-gadget span {
            display: none !important;
        }
        .goog-te-gadget {
            font-size: 0 !important;
        }
        .goog-te-combo {
            background: rgba(255,255,255,0.1) !important;
            border: 1px solid rgba(255,255,255,0.2) !important;
            border-radius: 0.5rem !important;
            padding: 0.5rem 2rem 0.5rem 0.75rem !important;
            font-size: 0.875rem !important;
            color: white !important;
            backdrop-filter: blur(10px) !important;
            transition: all 0.2s ease-in-out;
        }
        .goog-te-combo:hover {
            background: rgba(255,255,255,0.15) !important;
            border-color: rgba(14,165,233,0.5) !important;
        }
    </style>

    <!-- Hero Section -->
    <section class="relative z-10 container mx-auto px-4 py-6 text-center">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-white via-blue-100 to-cyan-100 bg-clip-text text-transparent mb-3 text-balance leading-tight">
                AI/ML-Based Solar Power Prediction
            </h2>
            <p class="text-blue-200 mb-6 text-pretty max-w-2xl mx-auto">
                Accurate, adaptive, and site-specific solar power insights powered by advanced machine learning algorithms.
            </p>
            <div class="flex flex-wrap justify-center gap-6 text-sm text-blue-300">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-lg flex items-center justify-center mr-2">
                        <i class="fas fa-chart-line text-white text-xs"></i>
                    </div>
                    <span>Real-time Predictions</span>
                </div>
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-emerald-500 rounded-lg flex items-center justify-center mr-2">
                        <i class="fas fa-map-marker-alt text-white text-xs"></i>
                    </div>
                    <span>Location-based Analysis</span>
                </div>
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center mr-2">
                        <i class="fas fa-cog text-white text-xs"></i>
                    </div>
                    <span>Optimization Insights</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Location Permission Modal -->
    <div id="locationModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-3xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <div class="text-center">
                <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-map-marker-alt text-white text-2xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-white mb-4">Location Access</h3>
                <p class="text-blue-200 mb-6">We need your location to provide accurate solar predictions for your area.</p>
                <div class="flex flex-col space-y-3">
                    <button id="allowLocation" class="bg-gradient-to-r from-blue-500 to-cyan-500 text-white py-3 rounded-xl hover:from-blue-600 hover:to-cyan-600 transition-all duration-200 shadow-lg hover:shadow-xl font-medium">
                        Allow Location
                    </button>
                    <button id="manualLocation" class="bg-white/10 backdrop-blur-md border border-white/20 text-white py-3 rounded-xl hover:bg-white/20 transition-all duration-200 font-medium">
                        Enter Manually
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="relative z-10 container mx-auto px-4 py-4 h-[calc(100vh-200px)] overflow-hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 h-full">
            
            <!-- LEFT: Inputs -->
            <div class="space-y-4 overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-white/20 scrollbar-track-transparent flex flex-col items-start">
                <!-- Location Card -->
                <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-2xl p-4 shadow-xl hover:shadow-2xl transition-all duration-300 w-full">
                    <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
                        <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-emerald-500 rounded-lg flex items-center justify-center mr-2">
                            <i class="fas fa-map-marker-alt text-white text-sm"></i>
                        </div>
                        Location
                    </h3>
                    <div id="locationDisplay" class="hidden">
                        <p class="text-blue-200 text-sm" id="locationText"></p>
                        <button id="changeLocation" class="text-cyan-400 hover:text-cyan-300 text-sm mt-2 hover:underline transition-colors">Change location</button>
                    </div>
                    <div id="manualLocationInput" class="hidden relative">
                        <input type="text" id="cityInput" placeholder="Enter city, state"
                            class="w-full p-3 bg-white/10 backdrop-blur-md border border-white/20 rounded-xl focus:ring-2 focus:ring-cyan-400 focus:border-transparent text-white placeholder-blue-300 text-sm">
                    </div>
                </div>

                <!-- Panel Config -->
                <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-2xl p-4 shadow-xl hover:shadow-2xl transition-all duration-300 w-full">
                    <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-lg flex items-center justify-center mr-2">
                            <i class="fas fa-solar-panel text-white text-sm"></i>
                        </div>
                        Panel Configuration
                    </h3>
                    <form id="solarForm" class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-blue-200 mb-1">Surface Area (m¬≤)</label>
                                <input type="number" id="surfaceArea" value="20" min="1" max="1000"
                                    class="w-full p-2 bg-white/10 backdrop-blur-md border border-white/20 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-transparent text-white placeholder-blue-300 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-blue-200 mb-1">Tilt (¬∞)</label>
                                <input type="number" id="tiltAngle" value="30" min="0" max="90"
                                    class="w-full p-2 bg-white/10 backdrop-blur-md border border-white/20 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-transparent text-white placeholder-blue-300 text-sm">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-blue-200 mb-1">Azimuth (¬∞)</label>
                            <input type="number" id="azimuthAngle" value="180" min="0" max="360"
                                class="w-full p-2 bg-white/10 backdrop-blur-md border border-white/20 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-transparent text-white placeholder-blue-300 text-sm">
                        </div>
                    </form>
                </div>

                <!-- Predict Button -->
                <button id="predictBtn"
                    class="w-full bg-gradient-to-r from-blue-500 via-cyan-500 to-green-500 text-white py-4 rounded-2xl font-semibold text-sm hover:shadow-2xl hover:scale-[1.02] transition-all duration-300 shadow-xl"
                    onclick="submitFormToBackend()">
                    <i class="fas fa-magic mr-2"></i> Predict Solar Output
                </button>
                
                <!-- Weather Info -->
                <div id="weatherBox" class="hidden bg-white/10 backdrop-blur-xl border border-white/20 rounded-2xl p-4 shadow-xl w-full">
                    <h3 class="text-sm font-semibold text-white mb-2 flex items-center">
                        <div class="w-6 h-6 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-lg flex items-center justify-center mr-2">
                            <i class="fas fa-cloud-sun-rain text-white text-xs"></i>
                        </div>
                        Current Weather
                    </h3>
                    <div id="weatherDetails" class="text-xs space-y-2 text-blue-200"></div>
                </div>
            </div>

            <!-- RIGHT: Results -->
            <div id="resultsSection" class="space-y-4 overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-white/20 scrollbar-track-transparent flex flex-col items-start">

                <!-- Placeholder -->
                <div id="resultsPlaceholder" class="flex flex-col items-center justify-center p-8 bg-white/5 backdrop-blur-xl border border-white/10 rounded-2xl shadow-xl text-center h-full w-full">
                    <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-3xl flex items-center justify-center mb-4">
                        <i class="fas fa-solar-panel text-white text-3xl"></i>
                    </div>
                    <p class="text-white font-semibold text-lg mb-2">No predictions yet</p>
                    <p class="text-blue-300 text-sm">Enter your panel details and click <b>Predict</b> to see results.</p>
                </div>

                <!-- Main Prediction -->
                <div id="predictionCard" class="hidden bg-gradient-to-br from-blue-500 via-cyan-500 to-green-500 rounded-2xl p-4 text-white shadow-2xl text-center border border-white/20 w-full">
                    <div class="w-10 h-10 bg-white/20 backdrop-blur-md rounded-xl flex items-center justify-center mx-auto mb-2">
                        <i class="fas fa-bolt text-white text-lg"></i>
                    </div>
                    <h3 class="text-base font-semibold mb-1">Predicted Solar Output</h3>
                    <div id="predictedOutput" class="text-3xl font-bold mb-1">0</div>
                    <p class="text-xs opacity-80">kWh (5 days)</p>
                </div>

                <!-- Charts Row -->
                <!-- Increased chart container height from h-24 to h-32 for better visibility -->
                <div class="grid grid-cols-2 gap-3 hidden w-full" id="chartsRow">
                    <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-2xl p-3 shadow-xl min-h-0">
                        <h3 class="text-sm font-semibold text-white mb-2 flex items-center">
                            <div class="w-4 h-4 bg-gradient-to-br from-blue-500 to-cyan-500 rounded mr-2"></div>
                            Today Hourly
                        </h3>
                        <div class="relative h-32 w-full">
                            <canvas id="timeSeriesChart" class="absolute inset-0 w-full h-full"></canvas>
                        </div>
                    </div>
                    <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-2xl p-3 shadow-xl min-h-0">
                        <h3 class="text-sm font-semibold text-white mb-2 flex items-center">
                            <div class="w-4 h-4 bg-gradient-to-br from-green-500 to-emerald-500 rounded mr-2"></div>
                            5-Day Output
                        </h3>
                        <div class="relative h-32 w-full">
                            <canvas id="fiveDaysChart" class="absolute inset-0 w-full h-full"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Config Row -->
                <!-- Increased config row container height from h-24 to h-32 for better visibility -->
                <div class="grid grid-cols-2 gap-3 hidden w-full" id="configRow">
                    <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-2xl p-3 shadow-xl min-h-0">
                        <h3 class="text-sm font-semibold text-white mb-2 flex items-center">
                            <div class="w-4 h-4 bg-gradient-to-br from-purple-500 to-pink-500 rounded mr-2"></div>
                            Config Comparison
                        </h3>
                        <div class="relative h-32 w-full">
                            <canvas id="comparisonChart" class="absolute inset-0 w-full h-full"></canvas>
                        </div>
                    </div>
                    <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-2xl p-3 shadow-xl min-h-0 overflow-hidden">
                        <h3 class="text-sm font-semibold text-white mb-2 flex items-center">
                            <div class="w-4 h-4 bg-gradient-to-br from-yellow-500 to-orange-500 rounded mr-2"></div>
                            Recommendations
                        </h3>
                        <div class="h-32 overflow-y-auto">
                            <div id="insights" class="text-xs space-y-1"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Google Translate Script -->
    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'en',
                includedLanguages: 'en,hi,gu',
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE
            }, 'google_translate_element');
        }
    </script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

        <!-- Added custom CSS for better chart container control -->
        <style>
            /* Chart container improvements */
            .chart-container {
                position: relative;
                height: 128px; /* h-32 equivalent - increased from 96px */
                width: 100%;
                overflow: hidden;
            }
            
            .chart-container canvas {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                max-width: 100% !important;
                max-height: 100% !important;
            }

            /* Ensure grid items don't overflow */
            #chartsRow > div,
            #configRow > div {
                min-width: 0;
                min-height: 0;
                overflow: hidden;
            }

            /* Scrollbar styling for recommendations */
            .overflow-y-auto::-webkit-scrollbar {
                width: 2px;
            }
            
            .overflow-y-auto::-webkit-scrollbar-track {
                background: transparent;
            }
            
            .overflow-y-auto::-webkit-scrollbar-thumb {
                background: rgba(255, 255, 255, 0.2);
                border-radius: 1px;
            }
        </style>

    <script>
        // Global variables
        let userLocation = null;
        let timeSeriesChart = null;
        let comparisonChart = null;
        let latestData = null;
        let latestRec = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            showLocationModal();
            setupEventListeners();
        });

        function showLocationModal() {
            document.getElementById('locationModal').classList.remove('hidden');
        }

        function hideLocationModal() {
            document.getElementById('locationModal').classList.add('hidden');
        }

        function setupEventListeners() {
            document.getElementById('allowLocation').addEventListener('click', requestLocation);
            document.getElementById('manualLocation').addEventListener('click', showManualLocationInput);
            document.getElementById('changeLocation').addEventListener('click', showManualLocationInput);
            document.getElementById('downloadCsvBtn').addEventListener('click', () => downloadCSV(latestData, latestRec));
            document.getElementById('downloadPdfBtn').addEventListener('click', () => downloadPDF(latestData, latestRec));

            
            //  Added location suggestions functionality
            const cityInput = document.getElementById('cityInput');
            cityInput.addEventListener('input', handleLocationInput);
            cityInput.addEventListener('blur', function(e) {
                // Delay hiding suggestions to allow clicking
                setTimeout(() => {
                    document.getElementById('locationSuggestions').classList.add('hidden');
                }, 200);
            });
        }

        //  Added location input handler with suggestions
        async function handleLocationInput(e) {
            const query = e.target.value.trim();
            let suggestionsContainer = document.getElementById('locationSuggestions');

            if (!suggestionsContainer) {
                suggestionsContainer = document.createElement("div");
                suggestionsContainer.id = "locationSuggestions";
                suggestionsContainer.className = "absolute bg-white/10 backdrop-blur-xl border border-white/20 rounded-lg shadow-lg z-[9999] max-h-48 overflow-y-auto hidden";
                document.body.appendChild(suggestionsContainer);
            }

            const inputRect = e.target.getBoundingClientRect();
            suggestionsContainer.style.position = "absolute";
            suggestionsContainer.style.top = `${inputRect.bottom + window.scrollY}px`;
            suggestionsContainer.style.left = `${inputRect.left + window.scrollX}px`;
            suggestionsContainer.style.width = `${inputRect.width}px`;

            if (query.length < 3) {
                suggestionsContainer.classList.add("hidden");
                return;
            }

            try {
                const GEOAPIFY_KEY = "8a461b974b7241adb1db7aa4d8af4f14";
                const url = `https://api.geoapify.com/v1/geocode/autocomplete?text=${encodeURIComponent(query)}&limit=5&filter=countrycode:in&apiKey=${GEOAPIFY_KEY}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.features && data.features.length > 0) {
                    suggestionsContainer.innerHTML = data.features.map(place => {
                        const props = place.properties;
                        return `
                            <div class="p-3 hover:bg-white/10 cursor-pointer border-b border-white/10 last:border-b-0 text-sm"
                                onclick="selectLocation('${props.city || props.county || "Unknown City"}', '${props.state || "Unknown State"}', ${place.geometry.coordinates[1]}, ${place.geometry.coordinates[0]})">
                                <div class="font-medium text-white">${props.city || props.county || "Unknown City"}</div>
                                <div class="text-blue-300 text-xs">${props.state || "Unknown State"}</div>
                            </div>
                        `;
                    }).join('');
                    suggestionsContainer.classList.remove("hidden");
                } else {
                    suggestionsContainer.classList.add("hidden");
                }
            } catch (error) {
                console.error("Autocomplete failed:", error);
                suggestionsContainer.classList.add("hidden");
            }
        }

        //  Added location selection function
        function selectLocation(city, state, lat, lon) {
            userLocation = { city, state, lat, lon };
            document.getElementById('cityInput').value = `${city}, ${state}`;
            document.getElementById('locationSuggestions').classList.add('hidden');
            displayLocation();
        }

        function requestLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async function (position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;

                        try {
                            const url = `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`;
                            const response = await fetch(url);
                            const data = await response.json();

                            if (data) {
                                userLocation = {
                                    lat,
                                    lon,
                                    area: data.locality || data.localityInfo?.administrative?.[2]?.name || "Unknown Area",
                                    city: data.city || data.locality || "Unknown City",
                                    state: data.principalSubdivision || "Unknown State"
                                };

                                console.log("User location (BigDataCloud):", userLocation);
                                displayLocation();
                                hideLocationModal();
                            } else {
                                alert("Unable to fetch location details.");
                                showManualLocationInput();
                            }
                        } catch (error) {
                            console.error("Reverse geocoding failed:", error);
                            showManualLocationInput();
                        }
                    },
                    function (error) {
                        console.error("Geolocation error:", error);
                        showManualLocationInput();
                    }
                );
            } else {
                alert("Geolocation is not supported by this browser.");
                showManualLocationInput();
            }
        }

        function getMockLocation(lat, lon) {
            // Mock function - in real app, use reverse geocoding API
            return locationSuggestions[Math.floor(Math.random() * locationSuggestions.length)];
        }

        function showManualLocationInput() {
            document.getElementById('locationDisplay').classList.add('hidden');
            document.getElementById('manualLocationInput').classList.remove('hidden');
            hideLocationModal();
        }

        function displayLocation() {
            const locationText = document.getElementById('locationText');
            locationText.textContent = `${userLocation.city}, ${userLocation.state}`;
            document.getElementById('locationDisplay').classList.remove('hidden');
            document.getElementById('manualLocationInput').classList.add('hidden');
        }

        async function submitFormToBackend() {
            if (!userLocation) {
                alert("Please set your location first.");
                return;
            }

            const btn = document.getElementById('predictBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Predicting...';

            const surfaceArea = parseFloat(document.getElementById('surfaceArea').value);
            const tiltAngle = parseFloat(document.getElementById('tiltAngle').value);
            const azimuthAngle = parseFloat(document.getElementById('azimuthAngle').value);

            const payload = {
                surfaceArea,
                tiltAngle,
                azimuthAngle,
                lat: userLocation.lat,
                lon: userLocation.lon
            };

            try {
                const response = await fetch("/api/submit-form/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                console.log("Backend Response:", result);

                if (result.status === "success") {
                    updateDashboard(result.data);
                } else {
                    alert("Error: " + result.message);
                }
            } catch (error) {
                console.error("Form submit failed:", error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic mr-2"></i>Predict Solar Output';
            }
        }

        function getTodayISTDate() {
            const now = new Date();
            const istOffset = 5.5 * 60 * 60 * 1000; // 5h30m in ms
            const istTime = new Date(now.getTime() + istOffset - now.getTimezoneOffset() * 60000);
            return istTime.toISOString().split("T")[0];
        }

        function updateDashboard(data) {
            // Placeholder hide, results show
            document.getElementById('resultsPlaceholder').classList.add('hidden');
            document.getElementById('predictionCard').classList.remove('hidden');
            document.getElementById('chartsRow').classList.remove('hidden');
            document.getElementById('configRow').classList.remove('hidden');

            document.getElementById('downloadBtns').classList.remove('hidden');

            latestData = data;
            latestRec = data.recommendation;

            const rec = data.recommendation;
            document.getElementById('predictedOutput').textContent = rec.current_total || 0;

            const insightsDiv = document.getElementById("insights");
            insightsDiv.innerHTML = `
                <div class="p-2 bg-green-500/20 backdrop-blur-md border border-green-400/30 rounded-lg">
                    <b class="text-green-300">Current:</b> <span class="text-white">${rec.current_tilt}¬∞ | ${rec.current_azimuth}¬∞</span>
                </div>
                <div class="p-2 bg-blue-500/20 backdrop-blur-md border border-blue-400/30 rounded-lg">
                    <b class="text-blue-300">Optimal:</b> <span class="text-white">${rec.optimal_tilt}¬∞ | ${rec.optimal_azimuth}¬∞</span>
                </div>
                <div class="p-2 bg-yellow-500/20 backdrop-blur-md border border-yellow-400/30 rounded-lg">
                    <b class="text-yellow-300">Gain:</b> <span class="text-white">${rec.potential_gain_percent}% more output</span>
                </div>
            `;

            // Charts
            const today = getTodayISTDate();
            const todayHourly = data.hourly.filter(h => h.datetime.split("T")[0] === today);

            // Weather Info
            if (data.weather) {
                const w = data.weather;
                const weatherBox = document.getElementById("weatherBox");
                const details = document.getElementById("weatherDetails");

                details.innerHTML = `
                    <div class="grid grid-cols-2 gap-2">
                        <div class="flex items-center"><span class="text-yellow-400">üå°Ô∏è</span> <b class="ml-1 text-blue-300">Temp:</b> <span class="ml-1 text-white">${w.temperature}¬∞C</span></div>
                        <div class="flex items-center"><span class="text-blue-400">üíß</span> <b class="ml-1 text-blue-300">Humidity:</b> <span class="ml-1 text-white">${w.humidity}%</span></div>
                        <div class="flex items-center"><span class="text-gray-400">üå¨Ô∏è</span> <b class="ml-1 text-blue-300">Wind:</b> <span class="ml-1 text-white">${w.wind_speed} m/s</span></div>
                        <div class="flex items-center"><span class="text-gray-300">‚òÅÔ∏è</span> <b class="ml-1 text-blue-300">Clouds:</b> <span class="ml-1 text-white">${w.cloud_cover}%</span></div>
                        <div class="flex items-center"><span class="text-yellow-300">‚òÄÔ∏è</span> <b class="ml-1 text-blue-300">GHI:</b> <span class="ml-1 text-white">${w.ghi} W/m¬≤</span></div>
                        <div class="flex items-center"><span class="text-orange-300">üîÜ</span> <b class="ml-1 text-blue-300">DNI:</b> <span class="ml-1 text-white">${w.dni} W/m¬≤</span></div>
                    </div>
                `;
                weatherBox.classList.remove("hidden");
            }

            createLineChart(todayHourly);
            createFiveDaysChart(data.daily);
            createBarChart(data.daily, rec);
        }

        let fiveDaysChart = null;

        function createFiveDaysChart(dailyData) {
            const ctx = document.getElementById('fiveDaysChart').getContext('2d');
            if (fiveDaysChart) fiveDaysChart.destroy();

            fiveDaysChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dailyData.map(d => d.datetime.split("T")[0]),
                    datasets: [{
                        label: "Daily kWh",
                        data: dailyData.map(d => d.daily_kwh),
                        backgroundColor: "rgba(16, 185, 129, 0.8)",
                        borderColor: "rgba(16, 185, 129, 1)",
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 5,
                            bottom: 5,
                            left: 5,
                            right: 5
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            callbacks: {
                                label: function (context) {
                                    return context.raw.toFixed(2) + " kWh";
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { 
                                color: 'rgba(255, 255, 255, 0.7)', 
                                font: { size: 8 },
                                maxTicksLimit: 4
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: { 
                            ticks: { 
                                color: 'rgba(255, 255, 255, 0.7)', 
                                font: { size: 8 },
                                maxRotation: 0
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        function createLineChart(hourlyData) {
            const ctx = document.getElementById('timeSeriesChart').getContext('2d');
            if (timeSeriesChart) timeSeriesChart.destroy();

            timeSeriesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hourlyData.map(h => {
                        const [date, time] = h.datetime.split("T");
                        return time.slice(0,5);
                    }),
                    datasets: [{
                        label: "Hourly kWh",
                        data: hourlyData.map(h => h.predicted_kwh),
                        borderColor: "rgba(14, 165, 233, 1)",
                        backgroundColor: "rgba(14, 165, 233, 0.2)",
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 5,
                            bottom: 5,
                            left: 5,
                            right: 5
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: 'white',
                            bodyColor: 'white'
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { 
                                color: 'rgba(255, 255, 255, 0.7)', 
                                font: { size: 8 },
                                maxTicksLimit: 4
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: { 
                            ticks: { 
                                color: 'rgba(255, 255, 255, 0.7)', 
                                font: { size: 8 },
                                maxRotation: 0
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        function createBarChart(dailyData, rec) {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            if (comparisonChart) comparisonChart.destroy();

            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ["Current", "Optimal"],
                    datasets: [
                        {
                            label: "Total kWh (5 Days)",
                            data: [rec.current_total, rec.optimal_total],
                            backgroundColor: ["rgba(14, 165, 233, 0.8)", "rgba(16, 185, 129, 0.8)"],
                            borderColor: ["rgba(14, 165, 233, 1)", "rgba(16, 185, 129, 1)"],
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 5,
                            bottom: 5,
                            left: 5,
                            right: 5
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ": " + context.raw + " kWh";
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { 
                                color: 'rgba(255, 255, 255, 0.7)', 
                                font: { size: 8 },
                                maxTicksLimit: 4
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: { 
                            ticks: { 
                                color: 'rgba(255, 255, 255, 0.7)', 
                                font: { size: 8 },
                                maxRotation: 0
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        function downloadCSV(data, rec) {
            const dailyRows = data.daily.map(d => `${d.datetime.split("T")[0]},${d.daily_kwh.toFixed(2)}`).join("\n");

            const weeklyTotal = data.daily.reduce((sum, d) => sum + d.daily_kwh, 0);
            const monthlyEstimate = (weeklyTotal / data.daily.length) * 30;

            const csvContent = `Solar Power Prediction Report
        Location,${userLocation.city}, ${userLocation.state}
        Predicted Daily Output (First Day),${data.daily[0].daily_kwh.toFixed(2)} kWh
        Weekly Total (5 Days),${weeklyTotal.toFixed(2)} kWh
        Monthly Estimate,${monthlyEstimate.toFixed(2)} kWh

        Daily Predictions:
        Date,Daily kWh
        ${dailyRows}

        Recommendations:
        Current Tilt,${rec.current_tilt}¬∞
        Current Azimuth,${rec.current_azimuth}¬∞
        Optimal Tilt,${rec.optimal_tilt}¬∞
        Optimal Azimuth,${rec.optimal_azimuth}¬∞
        Potential Gain,${rec.potential_gain_percent}%`;

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'solar-prediction-report.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function downloadPDF(data, rec) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const weeklyTotal = data.daily.reduce((sum, d) => sum + d.daily_kwh, 0);
            const monthlyEstimate = (weeklyTotal / data.daily.length) * 30;

            doc.setFontSize(16);
            doc.text("Solar Power Prediction Report", 20, 20);

            doc.setFontSize(12);
            doc.text(`Location: ${userLocation.city}, ${userLocation.state}`, 20, 35);
            doc.text(`Weekly Total (5 Days): ${weeklyTotal.toFixed(2)} kWh`, 20, 45);
            doc.text(`Monthly Estimate: ${monthlyEstimate.toFixed(2)} kWh`, 20, 55);

            doc.text("Daily Predictions:", 20, 70);
            let y = 80;
            data.daily.forEach(d => {
                doc.text(`${d.datetime.split("T")[0]} - ${d.daily_kwh.toFixed(2)} kWh`, 25, y);
                y += 10;
            });

            doc.text("Recommendations:", 20, y + 10);
            y += 20;
            doc.text(`Current Tilt: ${rec.current_tilt}¬∞`, 25, y); y += 10;
            doc.text(`Current Azimuth: ${rec.current_azimuth}¬∞`, 25, y); y += 10;
            doc.text(`Optimal Tilt: ${rec.optimal_tilt}¬∞`, 25, y); y += 10;
            doc.text(`Optimal Azimuth: ${rec.optimal_azimuth}¬∞`, 25, y); y += 10;
            doc.text(`Potential Gain: ${rec.potential_gain_percent}%`, 25, y);

            doc.save('solar-prediction-report.pdf');
        }

    </script>
</body>
</html>
